<script>

var nested_form_ready;
nested_form_ready = function() {

  moment.locale('en', {
    week: { dow: 1 } // Monday is the first day of the week
  });

  $('form').on('click', '.remove_fields', function(event) {
    $(this).prev('input[type=hidden]').val('1');
    $(this).closest('fieldset').hide();
    return event.preventDefault();
  });

  $('.add_fields').off().on('click', function(event) {
    var regexp, time;
    time = new Date().getTime();
    regexp = new RegExp($(this).data('id'), 'g');    
    $(this).before($(this).data('fields').replace(regexp, time));
    

    $('.country-picker:not(.select2-initialized), .as-select2-picker:not(.select2-initialized), .product-picker:not(.select2-initialized)').each(function(index){
    
      $(this).select2({
        // allowClear: true  
      });
         
      $(this).addClass("select2-initialized");
    });    

    $('.datetimepicker').each(function(index){  

      var datetime_format = "";
      if ($(this).data('pick-date')) {
        
        // DO NOT CHANGE TO "MMM DD YYYY" RAILS has problems parsing the Russian Date in that format
          datetime_format += "DD MMM YYYY ";
        // DO NOT CHANGE TO "MMM DD YYYY" RAILS has problems parsing the Russian Date in that format
        
      }
      if ($(this).data('pick-time')){
        datetime_format += "HH:mm";
      }

      $(this).datetimepicker({                                                                                
                    sideBySide: $(this).data('pick-time') && $(this).data('pick-date'),
                    stepping: 15,
                    locale: $(this).data('locale'),
                    format: datetime_format,
                    useCurrent: true,
                    defaultDate: $(this).data('value') == "" ? null : moment($(this).data('value'), moment.ISO_8601),                                        
                    showClear: $(this).data('show-clear')
                })
      }).click(function(){
          $(this).data("DateTimePicker").show()
    });

    $('.selectpicker:not(.selectpicker-initialized)').each(function(index){

      var selected = $(this).data('selected');
      if(selected != undefined){
        $(this).val(selected.toString().split(','));              
        $(this).selectpicker('render');         
      }
      else
        $(this).selectpicker();

      $(this).addClass("selectpicker-initialized");
       
    });

    $('.patent-picker').select2({         
      minimumInputLength: 0,
      ajax: {
          url: "/supplier_search/patents",
          dataType: 'json',
          delay: 250,          
          data: function (params) {
            return {
              term: params.term, // search term
              supplier_id: $('.supplier-picker').val(),
              page: params.page
            };
          },
          processResults: function (data, page) {
            // parse the results into the format expected by Select2.
            // since we are using custom formatting functions we do not need to
            // alter the remote JSON data
            return {
              results: data
            };
          },      
        },        
      }); 

    $(this).trigger("after_add_fields_click");

    return event.preventDefault();
  });
};

$(document).ready(nested_form_ready);
$(document).on('page:load', nested_form_ready);
</script>